<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>رمضان 2026 | النسخة الفاخرة APK</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest/dist/hls.min.js"></script>
    <script src="capacitor.js"></script>
    <style>
        :root {
            --gold: #d4a534;
            --dark: #020205;
            --dark-2: #050510;
            --card: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.08);
            --radius: 12px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--dark);
            color: #fff;
            font-family: 'Cairo', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            user-select: none;
        }

        .bg-glow {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at 0% 0%, #0a0a20 0%, var(--dark) 70%);
            z-index: -1;
        }

        #splash {
            position: fixed;
            inset: 0;
            z-index: 10000;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease-out;
        }

        .splash-logo {
            width: 160px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.05);
            }
        }

        #app {
            display: block;
            height: 100vh;
            opacity: 0;
            transition: opacity 1s;
        }

        main {
            width: 100%;
            height: 100vh;
            overflow-y: auto;
            padding-bottom: 100px;
        }

        .hero {
            height: 50vh;
            margin: 30px;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: flex-end;
            padding: 40px;
            background: #000;
        }

        .hero-bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            opacity: 0.6;
        }

        .hero::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, var(--dark), transparent);
        }

        .hero-content {
            position: relative;
            z-index: 2;
            max-width: 600px;
        }

        .hero-title {
            font-size: 2.5rem;
            font-weight: 900;
            margin: 5px 0;
            line-height: 1.1;
        }

        .hero-btns {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 35px;
            border-radius: 10px;
            font-weight: 900;
            font-size: 1.2rem;
            cursor: pointer;
            border: none;
            transition: 0.3s;
        }

        .btn-play {
            background: #fff;
            color: #000;
        }

        .btn-play:focus {
            background: var(--gold);
            transform: scale(1.1);
            outline: none;
        }

        .row {
            margin: 40px;
        }

        .row-title {
            font-size: 1.6rem;
            font-weight: 900;
            margin-bottom: 25px;
            color: var(--gold);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(135px, 1fr));
            gap: 15px;
        }

        .card {
            background: var(--card);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), border-color 0.2s, box-shadow 0.3s;
            border: 4px solid transparent;
            padding: 0;
            color: inherit;
            text-align: right;
            width: 100%;
            outline: none;
        }

        .card:focus {
            transform: scale(1.1);
            border-color: var(--gold);
            box-shadow: 0 0 25px rgba(212, 165, 52, 0.4);
            z-index: 10;
        }

        .card-img {
            aspect-ratio: 2/3;
            width: 100%;
        }

        .card-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-body {
            padding: 15px;
        }

        .card-title {
            font-weight: 700;
            font-size: 1.1rem;
        }

        #modal {
            position: fixed;
            inset: 0;
            z-index: 2000;
            background: #000;
            display: none;
            flex-direction: row-reverse;
        }

        #modal.open {
            display: flex;
        }

        .modal-sidebar {
            width: 350px;
            background: var(--dark-2);
            height: 100vh;
            border-left: 1px solid var(--border);
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .sidebar-title {
            color: var(--gold);
            font-weight: 900;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .player-main {
            flex: 1;
            height: 100vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .video-container {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            position: relative;
        }

        video {
            width: 100%;
            height: 100%;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 100;
        }

        .close-btn:focus {
            background: #e50914;
            outline: none;
        }

        .ep-section {
            padding: 30px;
        }

        .ep-grid {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 20px;
        }

        .side-card {
            display: flex;
            gap: 10px;
            background: rgba(255, 255, 255, 0.03);
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            align-items: center;
            text-align: right;
        }

        .side-card img {
            width: 60px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
        }

        .side-card-title {
            font-weight: 700;
            font-size: 0.9rem;
            flex: 1;
        }

        .side-card:focus,
        .side-card.active {
            border-color: var(--gold);
            background: rgba(212, 165, 52, 0.1);
            outline: none;
        }

        .ep-card {
            flex: 0 0 160px;
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            border: 4px solid transparent;
            transition: all 0.2s;
            outline: none;
        }

        .ep-card:focus,
        .ep-card.active {
            border-color: var(--gold);
            background: rgba(212, 165, 52, 0.2);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(212, 165, 52, 0.3);
        }

        .fav-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px;
            border-radius: 5px;
            font-size: 1.2rem;
            pointer-events: none;
        }

        .error-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 20000;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .error-content {
            background: var(--dark-2);
            padding: 40px;
            border-radius: 20px;
            border: 2px solid var(--gold);
        }

        .error-content p {
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        footer {
            padding: 60px;
            text-align: center;
            opacity: 0.5;
            border-top: 1px solid var(--border);
        }

        footer strong {
            color: var(--gold);
        }

        /* ── FOCUS RING (Milestone 6) ── */
        .focus-ring {
            position: fixed;
            border: 4px solid var(--gold);
            border-radius: 12px;
            pointer-events: none;
            z-index: 9999;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 20px rgba(212, 165, 52, 0.5);
            opacity: 0;
        }
    </style>
</head>

<body>
    <div class="bg-glow"></div>
    <div id="focusRing" class="focus-ring"></div>

    <div id="splash">
        <img src="logo.png" class="splash-logo" alt="Karas">
        <div style="font-size: 3rem; font-weight: 900; color: var(--gold); margin-top: 20px;">KARAS ULTRA</div>
        <p style="opacity: 0.5;">جاري تحضير التجربة السينمائية...</p>
    </div>

    <div id="app">
        <main>
            <div style="padding: 40px 40px 0; display:flex; justify-content:space-between; align-items:center;">
                <img src="logo.png" style="height: 50px;">
                <input type="text" id="searchInput" placeholder="بحث..."
                    style="background:rgba(255,255,255,0.05); border:1px solid var(--border); color:#fff; padding:10px 20px; border-radius:10px; width:300px;">
            </div>

            <div class="hero" id="hero">
                <div class="hero-bg" id="heroBg"></div>
                <div class="hero-content">
                    <h1 class="hero-title" id="heroTitle">جاري التحميل...</h1>
                    <div class="hero-btns">
                        <button class="btn btn-play" id="heroPlay">▶ تشغيل</button>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="row-title">جميع المسلسلات</div>
                <div class="grid" id="grid"></div>
            </div>

            <footer>
                <p>بواسطة <strong id="adminTrigger">Karas</strong> | رمضان 2026 Ultra APK</p>
                <p style="font-size: 0.8rem;">نسخة التلفزيون المحسنة v3.0.1</p>
            </footer>
        </main>
    </div>

    <div id="modal">
        <div class="modal-sidebar">
            <div class="sidebar-title">قائمة المسلسلات</div>
            <div id="sideSeriesGrid"></div>
        </div>
        <div class="player-main">
            <div class="video-container">
                <button class="close-btn" id="closeVid" tabindex="0">✕ رجوع</button>
                <video id="vPlayer" controls playsinline></video>
            </div>
            <div class="ep-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 id="mTitle" style="margin:0">الحلقات</h2>
                    <button class="btn" id="favBtn" tabindex="0"
                        style="padding:10px; background:rgba(212, 165, 52, 0.1); border:2px solid var(--gold); border-radius:50%; width:50px; height:50px; display:flex; align-items:center; justify-content:center;">⭐</button>
                </div>
                <div class="ep-grid" id="epGrid"></div>
            </div>
        </div>
    </div>

    <script>
        const API = "https://ramadan-v2j0.onrender.com";
        let allData = [], hls = null, devId = localStorage.getItem('tv_dev_id') || 'TV-' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('tv_dev_id', devId);

        async function init() {
            migrateStorage();

            const removeSplash = () => {
                const splash = document.getElementById('splash');
                if (!splash) return;
                splash.style.opacity = '0';
                setTimeout(() => {
                    if (splash.parentNode) splash.remove();
                    document.getElementById('app').style.opacity = '1';
                }, 800);
            };

            const failsafe = setTimeout(removeSplash, 8000);

            try {
                const res = await fetch(`${API}/api/data?device_id=${devId}&v=${Date.now()}`);
                const data = await res.json();
                allData = data.series || [];

                if (allData.length > 0) {
                    const feat = allData[Math.floor(Math.random() * allData.length)];
                    document.getElementById('heroTitle').textContent = feat.title;
                    document.getElementById('heroBg').style.backgroundImage = `url(${feat.image})`;
                    document.getElementById('heroPlay').onclick = () => openSeries(feat.slug);
                }

                renderGrid(allData);
                renderSidebar();
                setupFocusManager();
                clearTimeout(failsafe);
                removeSplash();

                setTimeout(() => {
                    const firstCard = document.querySelector('.card');
                    if (firstCard) firstCard.focus();
                }, 1000);
            } catch (e) {
                showError("خطأ في الاتصال بالخادم", true);
            }
        }

        const STORAGE_VERSION = 'v1';
        function migrateStorage() {
            const current = localStorage.getItem('storage_version');
            if (current !== STORAGE_VERSION) {
                localStorage.setItem('storage_version', STORAGE_VERSION);
            }
        }

        function saveWatchHistory(slug, epIdx, time) {
            const history = JSON.parse(localStorage.getItem('watch_history_v1') || '{}');
            history[slug] = { idx: epIdx, time: time, date: Date.now() };
            localStorage.setItem('watch_history_v1', JSON.stringify(history));
        }

        function toggleFavorite(slug) {
            const favs = JSON.parse(localStorage.getItem('favorites_v1') || '[]');
            const idx = favs.indexOf(slug);
            if (idx === -1) favs.push(slug);
            else favs.splice(idx, 1);
            localStorage.setItem('favorites_v1', JSON.stringify(favs));
            renderGrid(allData);
            renderSidebar();
        }

        function isFavorite(slug) {
            const favs = JSON.parse(localStorage.getItem('favorites_v1') || '[]');
            return favs.includes(slug);
        }

        function setupFocusManager() {
            document.addEventListener('focusin', (e) => {
                if (e.target.matches('.card, .ep-card, .side-card, .btn, .close-btn, .btn-play')) {
                    smoothScrollIntoView(e.target);
                    updateFocusRing(e.target);
                }
            });
            document.addEventListener('focusout', () => {
                document.getElementById('focusRing').style.opacity = '0';
            });
        }

        function updateFocusRing(el) {
            const ring = document.getElementById('focusRing');
            const rect = el.getBoundingClientRect();
            ring.style.width = `${rect.width}px`;
            ring.style.height = `${rect.height}px`;
            ring.style.top = `${rect.top}px`;
            ring.style.left = `${rect.left}px`;
            ring.style.opacity = '1';
            ring.style.borderRadius = window.getComputedStyle(el).borderRadius;
        }

        let scrollDebounce;
        function smoothScrollIntoView(el) {
            clearTimeout(scrollDebounce);
            scrollDebounce = setTimeout(() => {
                el.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
            }, 100);
        }

        let lastFocusedElement = null;

        function renderGrid(series) {
            const grid = document.getElementById('grid');
            grid.innerHTML = series.map((s, i) => `
                <div class="card-wrapper" style="position:relative">
                    <button class="card" id="card-${s.slug}" onclick="openSeries('${s.slug}')" tabindex="0">
                        <div class="card-img"><img src="${s.image}" loading="lazy" onerror="handleImgError(this)"></div>
                        <div class="card-body">
                            <div class="card-title">${s.title}</div>
                        </div>
                    </button>
                    ${isFavorite(s.slug) ? '<div class="fav-badge">❤️</div>' : ''}
                </div>
            `).join('');
        }

        function renderSidebar() {
            const sideGrid = document.getElementById('sideSeriesGrid');
            sideGrid.innerHTML = allData.map(s => `
                <div class="side-card" id="side-${s.slug}" tabindex="0" onclick="openSeries('${s.slug}')">
                    <img src="${s.image}" loading="lazy" onerror="handleImgError(this)">
                    <div class="side-card-title">${s.title}</div>
                </div>
            `).join('');
        }

        async function openSeries(slug) {
            if (!document.activeElement.classList.contains('side-card')) {
                lastFocusedElement = document.activeElement;
            }

            document.querySelectorAll('.side-card').forEach(c => c.classList.remove('active'));
            const sideItem = document.getElementById(`side-${slug}`);
            if (sideItem) sideItem.classList.add('active');

            const series = allData.find(s => s.slug === slug);
            document.getElementById('mTitle').textContent = series.title;
            document.getElementById('epGrid').innerHTML = ' جاري التحميل...';
            document.getElementById('modal').classList.add('open');

            try {
                const res = await fetch(`${API}/api/episodes?slug=${slug}`);
                const data = await res.json();
                const eps = data.episodes || [];

                const history = JSON.parse(localStorage.getItem('watch_history_v1') || '{}');
                const lastEpIdx = (history[slug] && history[slug].idx < eps.length) ? history[slug].idx : 0;

                document.getElementById('epGrid').innerHTML = eps.map((ep, i) => `
                    <div class="ep-card ${i === lastEpIdx ? 'active' : ''}" tabindex="0" id="ep-btn-${i}" onclick="playEpisode('${ep.url}', ${i})">الحلقة ${i + 1}</div>
                `).join('');

                if (eps.length > 0) playEpisode(eps[lastEpIdx].url, lastEpIdx);

                document.getElementById('favBtn').onclick = () => {
                    toggleFavorite(slug);
                    document.getElementById('favBtn').textContent = isFavorite(slug) ? '❤️' : '⭐';
                };
                document.getElementById('favBtn').textContent = isFavorite(slug) ? '❤️' : '⭐';

                setTimeout(() => {
                    const target = document.getElementById(`ep-btn-${lastEpIdx}`) || document.getElementById('ep-btn-0');
                    if (target) target.focus();
                }, 300);
            } catch (e) {
                showError("خطأ في تحميل الحلقات");
            }
        }

        function showError(msg, isRetry = false) {
            const overlay = document.createElement('div');
            overlay.className = 'error-overlay';
            overlay.innerHTML = `
                <div class="error-content">
                    <p>${msg}</p>
                    ${isRetry ? '<button class="card" onclick="location.reload()" tabindex="0">إعادة المحاولة</button>' : '<button class="card" onclick="this.parentElement.parentElement.remove()" tabindex="0">إغلاق</button>'}
                </div>
            `;
            document.body.appendChild(overlay);
            overlay.querySelector('button').focus();
        }

        function handleImgError(el) {
            el.src = 'placeholder.png';
            el.onerror = null;
        }

        async function playEpisode(url, idx) {
            const player = document.getElementById('vPlayer');
            const slug = allData.find(s => document.getElementById('mTitle').textContent === s.title)?.slug;

            if (slug) {
                const history = JSON.parse(localStorage.getItem('watch_history_v1') || '{}');
                const lastTime = (history[slug] && history[slug].idx === idx) ? history[slug].time : 0;

                player.ontimeupdate = () => {
                    if (Math.floor(player.currentTime) % 5 === 0 && player.currentTime > 0) saveWatchHistory(slug, idx, player.currentTime);
                };

                const onResume = () => {
                    if (lastTime > 5) player.currentTime = lastTime;
                    player.removeEventListener('loadedmetadata', onResume);
                };
                player.addEventListener('loadedmetadata', onResume);

                document.querySelectorAll('.ep-card').forEach(e => e.classList.remove('active'));
                const epBtn = document.getElementById(`ep-btn-${idx}`);
                if (epBtn) epBtn.classList.add('active');
            }

            if (hls) { hls.destroy(); hls = null; }
            player.pause(); player.src = "";

            try {
                const res = await fetch(`${API}/api/stream?url=${encodeURIComponent(url)}`);
                const data = await res.json();
                if (data.url) {
                    if (data.url.includes('.m3u8')) {
                        if (Hls.isSupported()) {
                            hls = new Hls(); hls.loadSource(data.url); hls.attachMedia(player);
                            hls.on(Hls.Events.MANIFEST_PARSED, () => player.play());
                        } else { player.src = data.url; player.play(); }
                    } else { player.src = data.url; player.play(); }
                } else showError("رابط الفيديو غير صالح");
            } catch (e) { showError("حدث خطأ في طلب الفيديو"); }
        }

        document.getElementById('closeVid').onclick = () => {
            document.getElementById('modal').classList.remove('open');
            document.getElementById('vPlayer').pause();
            if (hls) hls.destroy();
            if (lastFocusedElement) setTimeout(() => lastFocusedElement.focus(), 100);
        };

        if (window.Capacitor && window.Capacitor.Plugins.App) {
            window.Capacitor.Plugins.App.addListener('backButton', () => {
                const modal = document.getElementById('modal');
                if (modal.classList.contains('open')) document.getElementById('closeVid').click();
                else window.Capacitor.Plugins.App.exitApp();
            });
        }

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' || e.key === 'Backspace') {
                const modal = document.getElementById('modal');
                if (modal.classList.contains('open')) {
                    document.getElementById('closeVid').click();
                    e.preventDefault();
                }
            }
        });

        document.getElementById('adminTrigger').onclick = () => {
            let clicks = parseInt(this.dataset.clicks || 0) + 1;
            this.dataset.clicks = clicks;
            if (clicks >= 5) window.location.href = API + "/admin";
            setTimeout(() => { this.dataset.clicks = 0; }, 2000);
        };

        init();
    </script>
</body>

</html>